{% extends 'core/base.html' %}

{% block title %}Inicio - Cosmofood{% endblock %}

{% block content %}
<!-- Contenedor con padding lateral para el carrusel -->
<div class="container mx-auto px-4 md:px-6 lg:px-8 py-6">
    <!-- Carrusel de Imágenes con Contenido -->
    <div class="relative w-full overflow-hidden bg-gray-900 rounded-2xl shadow-2xl" id="carousel" aria-live="polite">
        <!-- Slides -->
        <div class="relative w-full h-[400px] md:h-[500px] lg:h-[600px]" id="carouselSlides" role="list">
        {% for slide in slides %}
            <div class="carousel-slide absolute inset-0 opacity-0 transition-opacity duration-1000 ease-in-out" role="listitem" aria-roledescription="slide" data-slide-index="{{ forloop.counter0 }}">
                {% if slide.imagen %}
                    <img src="{{ slide.imagen.url }}" 
                         class="w-full h-full object-cover rounded-2xl" 
                         alt="{{ slide.titulo }}">
                {% else %}
                    <!-- Imagen por defecto según el orden del slide -->
                    {% if forloop.counter == 1 %}
                        <img src="https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=1200&h=600&fit=crop" 
                             class="w-full h-full object-cover rounded-2xl" 
                             alt="{{ slide.titulo }}">
                    {% elif forloop.counter == 2 %}
                        <img src="https://images.unsplash.com/photo-1513104890138-7c749659a591?w=1200&h=600&fit=crop" 
                             class="w-full h-full object-cover rounded-2xl" 
                             alt="{{ slide.titulo }}">
                    {% else %}
                        <img src="https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?w=1200&h=600&fit=crop" 
                             class="w-full h-full object-cover rounded-2xl" 
                             alt="{{ slide.titulo }}">
                    {% endif %}
                {% endif %}
                <div class="absolute inset-0 bg-black/50 flex items-center justify-center rounded-2xl">
                    <div class="text-center text-white px-4 animate-fade-in">
                        <h2 class="text-4xl md:text-5xl lg:text-6xl font-bold mb-4">{{ slide.titulo }}</h2>
                        <p class="text-xl md:text-2xl mb-6">{{ slide.subtitulo }}</p>
                        <a href="{{ slide.link_boton }}" 
                           class="bg-primary hover:bg-primary-dark text-white px-8 py-3 rounded-lg font-semibold text-lg transition duration-200 inline-block">
                            {{ slide.texto_boton }}
                        </a>
                    </div>
                </div>
            </div>
        {% empty %}
            <!-- Fallback por si no hay slides configurados -->
            <div class="carousel-slide absolute inset-0 opacity-100 flex items-center justify-center bg-gray-800 rounded-2xl">
                <p class="text-white text-2xl">No hay slides para mostrar. Configúralos en el panel de administración.</p>
            </div>
        {% endfor %}
    </div>
    
    <!-- Botones de navegación -->
    <button id="prevBtn" 
            type="button"
            class="absolute left-2 md:left-4 top-1/2 -translate-y-1/2 bg-white/30 hover:bg-white/50 backdrop-blur-sm text-white w-8 h-8 md:w-10 md:h-10 lg:w-12 lg:h-12 rounded-full flex items-center justify-center transition duration-300 z-10 focus:ring-4 focus:ring-white/70"
            aria-label="Previous slide">
        <i class="fas fa-chevron-left text-sm md:text-lg lg:text-2xl"></i>
        <span class="sr-only">Anterior</span>
    </button>
    <button id="nextBtn" 
            type="button"
            class="absolute right-2 md:right-4 top-1/2 -translate-y-1/2 bg-white/30 hover:bg-white/50 backdrop-blur-sm text-white w-8 h-8 md:w-10 md:h-10 lg:w-12 lg:h-12 rounded-full flex items-center justify-center transition duration-300 z-10 focus:ring-4 focus:ring-white/70"
            aria-label="Next slide">
        <i class="fas fa-chevron-right text-sm md:text-lg lg:text-2xl"></i>
        <span class="sr-only">Siguiente</span>
    </button>
    
    <!-- Indicadores -->
    <div class="absolute bottom-6 left-1/2 -translate-x-1/2 flex gap-2 z-10">
        {% for slide in slides %}
            <button type="button" class="carousel-indicator w-3 h-3 rounded-full bg-white/50 hover:bg-white transition duration-300" data-slide="{{ forloop.counter0 }}" aria-label="Go to slide {{ forloop.counter }}"></button>
        {% endfor %}
    </div>
    </div>
</div>

<div class="container mx-auto px-4">
    <!-- Hero Section -->
    <div class="grid lg:grid-cols-2 gap-12 items-center my-12">
        <div class="space-y-6">
            <h1 class="text-5xl lg:text-6xl font-bold leading-tight">
                Bienvenido a <span class="text-primary">Cosmofood</span>
            </h1>
            <p class="text-xl text-gray-600">
                La mejor comida rápida de Valdivia, ahora a un clic de distancia. 
                Realiza tus pedidos online y recibe en la comodidad de tu hogar.
            </p>
            <div class="flex flex-wrap gap-4">
                {% if not user.is_authenticated %}
                    <a href="{% url 'registro' %}" class="bg-primary hover:bg-primary-dark text-white px-8 py-3 rounded-lg font-semibold text-lg transition duration-200 inline-flex items-center gap-2">
                        <i class="fas fa-user-plus"></i> Crear Cuenta
                    </a>
                    <a href="{% url 'login' %}" class="border-2 border-primary text-primary hover:bg-primary hover:text-white px-8 py-3 rounded-lg font-semibold text-lg transition duration-200">
                        Iniciar Sesión
                    </a>
                {% else %}
                    <a href="{% url 'catalogo_productos' %}" class="bg-primary hover:bg-primary-dark text-white px-8 py-3 rounded-lg font-semibold text-lg transition duration-200 inline-flex items-center gap-2">
                        <i class="fas fa-utensils"></i> Ver Menú
                    </a>
                {% endif %}
            </div>
        </div>
        <div class="order-first lg:order-last">
            <img src="https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=600" 
                 class="w-full rounded-2xl shadow-2xl" alt="Comida rápida">
        </div>
    </div>

    <!-- Carrusel de Ofertas -->
    {% if productos_promocion %}
    <div class="my-12">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-3xl font-bold text-gray-800">
                <i class="fas fa-fire text-primary mr-2"></i>
                Últimas Ofertas
            </h2>
            <a href="{% url 'catalogo_productos' %}?ver_todo=1" class="text-primary hover:text-primary-dark font-semibold transition duration-200">
                Ver todas <i class="fas fa-arrow-right ml-1"></i>
            </a>
        </div>

        <div class="relative" id="ofertas-carousel">
            <!-- Contenedor del carrusel -->
            <div class="overflow-hidden">
                <div class="ofertas-track flex transition-transform duration-500 ease-in-out gap-6">
                    {% for producto in productos_promocion %}
                    <div class="ofertas-slide flex-shrink-0 w-full md:w-1/2 lg:w-1/3">
                        <div class="bg-white rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 overflow-hidden group relative">
                            <!-- Badge de oferta -->
                            <div class="absolute top-3 right-3 z-10 bg-red-500 text-white px-3 py-1 rounded-full text-sm font-bold shadow-lg">
                                <i class="fas fa-tag mr-1"></i>OFERTA
                            </div>

                            <!-- Imagen del producto -->
                            <div class="relative overflow-hidden h-48 bg-gray-200">
                                {% if producto.imagen %}
                                    <img src="{{ producto.imagen.url }}"
                                         alt="{{ producto.nombre }}"
                                         class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300">
                                {% else %}
                                    <div class="w-full h-full flex items-center justify-center bg-gradient-to-br from-gray-100 to-gray-200">
                                        <i class="fas fa-utensils text-6xl text-gray-400"></i>
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Información del producto -->
                            <div class="p-5">
                                <!-- Categoría -->
                                {% if producto.categoria %}
                                <span class="text-xs text-primary font-semibold uppercase tracking-wide">
                                    {{ producto.categoria.nombre }}
                                </span>
                                {% endif %}

                                <!-- Nombre -->
                                <h3 class="text-xl font-bold text-gray-800 mt-2 mb-2 line-clamp-1">
                                    {{ producto.nombre }}
                                </h3>

                                <!-- Descripción -->
                                <p class="text-gray-600 text-sm mb-4 line-clamp-2 h-10">
                                    {{ producto.descripcion|default:"Delicioso producto en oferta" }}
                                </p>

                                <!-- Precio y botón -->
                                <div class="flex items-center justify-between">
                                    <div class="text-2xl font-bold text-primary">
                                        ${{ producto.precio }}
                                    </div>
                                    {% if user.is_authenticated %}
                                    <form method="POST" action="{% url 'agregar_al_carrito' %}" class="inline">
                                        {% csrf_token %}
                                        <input type="hidden" name="product_id" value="{{ producto.id }}">
                                        <input type="hidden" name="cantidad" value="1">
                                        <button type="submit"
                                                class="bg-primary hover:bg-primary-dark text-white px-4 py-2 rounded-lg font-semibold transition duration-200 flex items-center gap-2">
                                            <i class="fas fa-cart-plus"></i>
                                            Agregar
                                        </button>
                                    </form>
                                    {% else %}
                                    <a href="{% url 'login' %}"
                                       class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg font-semibold transition duration-200 flex items-center gap-2">
                                        <i class="fas fa-sign-in-alt"></i>
                                        Iniciar Sesión
                                    </a>
                                    {% endif %}
                                </div>

                                <!-- Stock disponible -->
                                <div class="mt-3 text-xs text-gray-500">
                                    <i class="fas fa-box mr-1"></i>
                                    Stock: {{ producto.stock }} unidades
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Botones de navegación -->
            {% if productos_promocion|length > 3 %}
            <button id="ofertas-prev"
                    type="button"
                    class="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-4 bg-white hover:bg-gray-100 text-primary w-12 h-12 rounded-full shadow-lg flex items-center justify-center transition duration-300 z-10 focus:ring-4 focus:ring-primary/20"
                    aria-label="Anterior">
                <i class="fas fa-chevron-left text-xl"></i>
            </button>
            <button id="ofertas-next"
                    type="button"
                    class="absolute right-0 top-1/2 -translate-y-1/2 translate-x-4 bg-white hover:bg-gray-100 text-primary w-12 h-12 rounded-full shadow-lg flex items-center justify-center transition duration-300 z-10 focus:ring-4 focus:ring-primary/20"
                    aria-label="Siguiente">
                <i class="fas fa-chevron-right text-xl"></i>
            </button>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Carrusel de imágenes con efecto fade
    const slidesContainer = document.getElementById('carouselSlides');
    const slideElements = document.querySelectorAll('.carousel-slide');
    const indicators = document.querySelectorAll('.carousel-indicator');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    
    let currentSlide = 0;
    const totalSlides = indicators.length;
    let autoPlayInterval;
    let isTransitioning = false;
    
    function goToSlide(n) {
        if (isTransitioning || totalSlides === 0) return;
        
        isTransitioning = true;
        const previousSlide = currentSlide;
        currentSlide = (n + totalSlides) % totalSlides;
        
        // Fade out el slide anterior
        if (slideElements[previousSlide]) {
            slideElements[previousSlide].style.opacity = '0';
            slideElements[previousSlide].style.zIndex = '1';
        }
        
        // Fade in el slide nuevo
        if (slideElements[currentSlide]) {
            slideElements[currentSlide].style.zIndex = '2';
            // Pequeño delay para asegurar que la transición se aplique
            setTimeout(() => {
                slideElements[currentSlide].style.opacity = '1';
            }, 50);
        }
        
        // Actualizar indicadores
        indicators.forEach((indicator, index) => {
            indicator.setAttribute('aria-current', 'false');
            if (index === currentSlide) {
                indicator.classList.remove('bg-white/50');
                indicator.classList.add('bg-white');
                indicator.setAttribute('aria-current', 'true');
            } else {
                indicator.classList.remove('bg-white');
                indicator.classList.add('bg-white/50');
                indicator.setAttribute('aria-current', 'false');
            }
        });
        
        // Permitir nueva transición después de que termine la animación
        setTimeout(() => {
            isTransitioning = false;
        }, 1000); // Duración de la transición CSS
    }
    
    function nextSlide() {
        goToSlide(currentSlide + 1);
    }
    
    function prevSlide() {
        goToSlide(currentSlide - 1);
    }
    
    // Event listeners para botones
    nextBtn.addEventListener('click', () => {
        nextSlide();
        resetAutoPlay();
    });
    
    prevBtn.addEventListener('click', () => {
        prevSlide();
        resetAutoPlay();
    });
    
    // Event listeners para indicadores
    indicators.forEach((indicator, index) => {
        indicator.addEventListener('click', () => {
            goToSlide(index);
            resetAutoPlay();
        });
    });
    
    // Auto-play
    function startAutoPlay() {
        autoPlayInterval = setInterval(nextSlide, 5000);
    }
    
    function resetAutoPlay() {
        clearInterval(autoPlayInterval);
        startAutoPlay();
    }
    
    // Pausar auto-play cuando el mouse está sobre el carrusel
    const carousel = document.getElementById('carousel');
    carousel.addEventListener('mouseenter', () => {
        clearInterval(autoPlayInterval);
    });
    
    carousel.addEventListener('mouseleave', () => {
        startAutoPlay();
    });
    
    // Inicializar - mostrar el primer slide
    if (slideElements.length > 0) {
        slideElements[0].style.opacity = '1';
        slideElements[0].style.zIndex = '2';
        if (indicators[0]) {
            indicators[0].classList.remove('bg-white/50');
            indicators[0].classList.add('bg-white');
            indicators[0].setAttribute('aria-current', 'true');
        }
    }
    
    if (totalSlides > 1) {
        startAutoPlay();
    }
    
    // Soporte para gestos táctiles (swipe) en móviles
    let touchStartX = 0;
    let touchEndX = 0;
    
    carousel.addEventListener('touchstart', (e) => {
        touchStartX = e.changedTouches[0].screenX;
    });
    
    carousel.addEventListener('touchend', (e) => {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
    });
    
    function handleSwipe() {
        if (touchEndX < touchStartX - 50) {
            nextSlide();
            resetAutoPlay();
        }
        if (touchEndX > touchStartX + 50) {
            prevSlide();
            resetAutoPlay();
        }
    }

    // ========== CARRUSEL DE OFERTAS ==========
    const ofertasCarousel = document.getElementById('ofertas-carousel');

    if (ofertasCarousel) {
        const ofertasTrack = ofertasCarousel.querySelector('.ofertas-track');
        const ofertasSlides = ofertasCarousel.querySelectorAll('.ofertas-slide');
        const ofertasPrevBtn = document.getElementById('ofertas-prev');
        const ofertasNextBtn = document.getElementById('ofertas-next');

        let ofertasCurrentIndex = 0;
        let ofertasSlidesPerView = 3; // Por defecto 3 en desktop
        let ofertasAutoPlayInterval;
        let isOfertasTransitioning = false;

        // Calcular cuántos slides mostrar según el ancho de pantalla
        function calculateOfertasSlidesPerView() {
            const width = window.innerWidth;
            if (width < 768) {
                ofertasSlidesPerView = 1; // Móvil: 1 slide
            } else if (width < 1024) {
                ofertasSlidesPerView = 2; // Tablet: 2 slides
            } else {
                ofertasSlidesPerView = 3; // Desktop: 3 slides
            }
        }

        // Función para mover el carrusel
        function moveOfertasCarousel(index) {
            if (isOfertasTransitioning) return;

            isOfertasTransitioning = true;
            const maxIndex = Math.max(0, ofertasSlides.length - ofertasSlidesPerView);
            ofertasCurrentIndex = Math.max(0, Math.min(index, maxIndex));

            // Calcular el porcentaje de desplazamiento
            const slideWidth = 100 / ofertasSlidesPerView;
            const translateX = -(ofertasCurrentIndex * slideWidth);

            ofertasTrack.style.transform = `translateX(${translateX}%)`;

            // Actualizar estado de botones
            updateOfertasButtons();

            setTimeout(() => {
                isOfertasTransitioning = false;
            }, 500); // Duración de la transición CSS
        }

        // Actualizar visibilidad de botones
        function updateOfertasButtons() {
            if (!ofertasPrevBtn || !ofertasNextBtn) return;

            const maxIndex = Math.max(0, ofertasSlides.length - ofertasSlidesPerView);

            // Ocultar botón anterior si estamos al inicio
            if (ofertasCurrentIndex === 0) {
                ofertasPrevBtn.style.opacity = '0.5';
                ofertasPrevBtn.style.pointerEvents = 'none';
            } else {
                ofertasPrevBtn.style.opacity = '1';
                ofertasPrevBtn.style.pointerEvents = 'auto';
            }

            // Ocultar botón siguiente si estamos al final
            if (ofertasCurrentIndex >= maxIndex) {
                ofertasNextBtn.style.opacity = '0.5';
                ofertasNextBtn.style.pointerEvents = 'none';
            } else {
                ofertasNextBtn.style.opacity = '1';
                ofertasNextBtn.style.pointerEvents = 'auto';
            }
        }

        // Event listeners para botones
        if (ofertasPrevBtn) {
            ofertasPrevBtn.addEventListener('click', () => {
                moveOfertasCarousel(ofertasCurrentIndex - 1);
                resetOfertasAutoPlay();
            });
        }

        if (ofertasNextBtn) {
            ofertasNextBtn.addEventListener('click', () => {
                moveOfertasCarousel(ofertasCurrentIndex + 1);
                resetOfertasAutoPlay();
            });
        }

        // Auto-play del carrusel de ofertas
        function startOfertasAutoPlay() {
            ofertasAutoPlayInterval = setInterval(() => {
                const maxIndex = Math.max(0, ofertasSlides.length - ofertasSlidesPerView);
                if (ofertasCurrentIndex >= maxIndex) {
                    moveOfertasCarousel(0); // Volver al inicio
                } else {
                    moveOfertasCarousel(ofertasCurrentIndex + 1);
                }
            }, 5000); // Cambiar cada 5 segundos
        }

        function resetOfertasAutoPlay() {
            clearInterval(ofertasAutoPlayInterval);
            startOfertasAutoPlay();
        }

        // Pausar auto-play al pasar el mouse
        ofertasCarousel.addEventListener('mouseenter', () => {
            clearInterval(ofertasAutoPlayInterval);
        });

        ofertasCarousel.addEventListener('mouseleave', () => {
            startOfertasAutoPlay();
        });

        // Soporte para gestos táctiles (swipe) en móviles
        let ofertasTouchStartX = 0;
        let ofertasTouchEndX = 0;

        ofertasCarousel.addEventListener('touchstart', (e) => {
            ofertasTouchStartX = e.changedTouches[0].screenX;
        });

        ofertasCarousel.addEventListener('touchend', (e) => {
            ofertasTouchEndX = e.changedTouches[0].screenX;
            handleOfertasSwipe();
        });

        function handleOfertasSwipe() {
            if (ofertasTouchEndX < ofertasTouchStartX - 50) {
                moveOfertasCarousel(ofertasCurrentIndex + 1);
                resetOfertasAutoPlay();
            }
            if (ofertasTouchEndX > ofertasTouchStartX + 50) {
                moveOfertasCarousel(ofertasCurrentIndex - 1);
                resetOfertasAutoPlay();
            }
        }

        // Recalcular al cambiar tamaño de ventana
        window.addEventListener('resize', () => {
            const oldSlidesPerView = ofertasSlidesPerView;
            calculateOfertasSlidesPerView();

            // Si cambió el número de slides visibles, recalcular posición
            if (oldSlidesPerView !== ofertasSlidesPerView) {
                moveOfertasCarousel(ofertasCurrentIndex);
            }
        });

        // Inicializar
        calculateOfertasSlidesPerView();
        updateOfertasButtons();

        // Iniciar auto-play si hay más slides que los visibles
        if (ofertasSlides.length > ofertasSlidesPerView) {
            startOfertasAutoPlay();
        }
    }
</script>
{% endblock %}