{% extends 'core/admin/admin_base.html' %}

{% block title %}Detalle Pedido #{{ pedido.numero_pedido }}{% endblock %}

{% block page_title %}Detalle del Pedido #{{ pedido.numero_pedido }}{% endblock %}

{% block extra_css %}
<style>
    .header-sidebar-style {
        background: linear-gradient(135deg, #1a1f36 0%, #0f1419 100%);
        border: none;
        color: white;
    }
    .header-sidebar-style .card-title {
        color: white;
    }
    .header-sidebar-style i {
        color: var(--bs-primary);
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card table-card mb-4">
            <div class="card-header header-sidebar-style py-3">
                <h5 class="card-title mb-0">
                    <i class="fas fa-shopping-basket me-2"></i>
                    Productos del Pedido
                </h5>
            </div>
            <div class="card-body p-3">
                {% for detalle in pedido.detalles.all %}
                <div class="d-flex align-items-center justify-content-between {% if not forloop.last %}border-bottom pb-3 mb-3{% endif %}">
                    <div class="d-flex align-items-center">
                        {% if detalle.producto.imagen %}
                            <img src="{{ detalle.producto.imagen.url }}"
                                 alt="{{ detalle.producto.nombre }}"
                                 style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px;" class="me-3 shadow-sm">
                        {% else %}
                             <div class="bg-light d-flex align-items-center justify-content-center text-muted me-3" style="width: 50px; height: 50px; border-radius: 8px;">
                                <i class="fas fa-image fa-lg"></i>
                            </div>
                        {% endif %}
                        <div>
                            <span class="fw-bold">{{ detalle.cantidad }}x {{ detalle.producto.nombre }}</span><br>
                            <small class="text-muted">@ ${{ detalle.precio_unitario|floatformat:0 }} c/u</small>
                        </div>
                    </div>
                    <span class="fw-bold text-primary fs-5">${{ detalle.subtotal|floatformat:0 }}</span>
                </div>
                {% empty %}
                <p class="text-muted text-center p-3">Este pedido no tiene productos asociados.</p>
                {% endfor %}
            </div>
        </div>

        <div class="card table-card mb-4">
            <div class="card-header header-sidebar-style py-3">
                <h5 class="card-title mb-0">
                    <i class="fas fa-user me-2"></i>
                    Información del Cliente
                </h5>
            </div>
            <div class="card-body p-4">
                <dl class="row mb-0">
                    <dt class="col-sm-4 fw-medium text-muted">Nombre:</dt>
                    <dd class="col-sm-8">{{ pedido.nombre_referencia_cliente|default:pedido.cliente.get_full_name|default:pedido.cliente.username }}</dd>

                    <dt class="col-sm-4 fw-medium text-muted">Email:</dt>
                    <dd class="col-sm-8">{{ pedido.cliente.email|default:"N/A" }}</dd>

                    <dt class="col-sm-4 fw-medium text-muted">Teléfono:</dt>
                    <dd class="col-sm-8">{{ pedido.cliente.telefono|default:'No especificado' }}</dd>

                    <dt class="col-sm-4 fw-medium text-muted">Dirección Entrega:</dt>
                    <dd class="col-sm-8">{{ pedido.direccion_entrega|default:'No aplica (Retiro/Local)' }}</dd>

                    <dt class="col-sm-4 fw-medium text-muted">Notas Cliente:</dt>
                    <dd class="col-sm-8">{{ pedido.notas_cliente|default:'Ninguna' }}</dd>
                </dl>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card table-card mb-4 sticky-top" style="top: 80px;">
            <div class="card-header header-sidebar-style py-3">
                <h5 class="card-title mb-0 fw-bold">
                    <i class="fas fa-edit me-2"></i>
                    Gestionar Estado
                </h5>
            </div>
            <div class="card-body p-4">
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="cambiar_estado"> 
                    <div class="mb-3">
                        <label for="estadoActual" class="form-label fw-bold">Estado Actual:</label>
                        <p class="fs-5 mb-0" id="estadoActual">
                            <span class="badge rounded-pill {% if pedido.estado == 'pendiente' %}bg-warning text-dark{% elif pedido.estado == 'confirmado' %}bg-info{% elif pedido.estado == 'en_preparacion' %}bg-secondary{% elif pedido.estado == 'listo' %}bg-primary{% elif pedido.estado == 'en_camino' %}bg-dark{% elif pedido.estado == 'entregado' %}bg-success{% elif pedido.estado == 'cancelado' %}bg-danger{% endif %}">
                                {{ pedido.get_estado_display }}
                            </span>
                        </p>
                    </div>
                    <div class="mb-3">
                        <label for="estadoSelect" class="form-label">Cambiar a:</label>
                        <select name="estado" id="estadoSelect" class="form-select">
                            {% for value, display in estados_posibles %}
                                {% if pedido.tipo_orden == 'delivery' or value != 'en_camino' %}
                                    <option value="{{ value }}" {% if pedido.estado == value %}selected{% endif %}>
                                        {{ display }}
                                    </option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-save me-2"></i>Actualizar Estado
                    </button>
                </form>
            </div>
        </div>

        {% if pedido.tipo_orden == 'delivery' %} 
            <div class="card table-card mb-4">
                <div class="card-header header-sidebar-style py-3">
                    <h5 class="card-title mb-0 fw-bold">
                        <i class="fas fa-motorcycle me-2"></i>
                        Asignar Repartidor
                    </h5>
                </div>
                <div class="card-body p-4">
                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="asignar_repartidor"> 

                        <div class="mb-3">
                            <label for="repartidorActual" class="form-label fw-bold">Repartidor Actual:</label>
                            <p id="repartidorActual" class="fs-5 mb-0">
                                {% if pedido.repartidor %}
                                    <span class="badge bg-info text-dark rounded-pill">
                                        <i class="fas fa-user me-1"></i>
                                        {{ pedido.repartidor.usuario.username }}
                                    </span>
                                {% else %}
                                    <span class="badge bg-secondary rounded-pill">Ninguno asignado</span>
                                {% endif %}
                            </p>
                        </div>

                        <div class="mb-3">
                            <label for="repartidorSelect" class="form-label">Asignar a:</label>
                            <select name="repartidor_asignado" id="repartidorSelect" class="form-select">
                                <option value="">-- Ninguno --</option>
                                {% for rep in repartidores_disponibles %}
                                    <option value="{{ rep.usuario.pk }}" {% if pedido.repartidor and pedido.repartidor.usuario.pk == rep.usuario.pk %}selected{% endif %}>
                                        {{ rep.usuario.username }} ({{ rep.vehiculo|default:"S/V" }})
                                    </option>
                                {% empty %}
                                    <option value="" disabled>No hay repartidores disponibles</option>
                                {% endfor %}
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-check me-2"></i>Asignar / Cambiar Repartidor
                        </button>
                    </form>
                </div>
            </div>
        {% endif %} 
        <div class="card table-card mb-4">
            <div class="card-header header-sidebar-style py-3">
                <h5 class="card-title mb-0">
                    <i class="fas fa-file-invoice-dollar me-2"></i>
                    Resumen Financiero
                </h5>
            </div>
            <div class="card-body p-4">
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Subtotal:</span>
                    <span class="fw-medium">${{ pedido.subtotal|floatformat:0 }}</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Envío:</span>
                    <span class="fw-medium">${{ pedido.costo_envio|floatformat:0 }}</span>
                </div>
                <hr class="my-2">
                <div class="d-flex justify-content-between fw-bold fs-5 mb-3">
                    <span>Total:</span>
                    <span class="text-primary">${{ pedido.total|floatformat:0 }}</span>
                </div>
                <div class="d-flex justify-content-between">
                    <span class="text-muted">Método Pago:</span>
                    <span class="fw-semibold">{{ pedido.metodo_pago.nombre }}</span>
                </div>
                 <div class="d-flex justify-content-between mt-1">
                    <span class="text-muted small">Fecha Creación:</span>
                    <span class="fw-semibold small">{{ pedido.fecha_creacion|date:"d M Y, H:i" }}</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}